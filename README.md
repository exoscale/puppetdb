# PuppetDB

PuppetDB is the fast, scalable, and reliable data warehouse for Puppet. It caches data generated by Puppet, and gives you advanced features at awesome speed with a powerful API.

Exoscale
-----
This fork contains the version of puppetdb 2.3.x for internal use at Exoscale.

The Jenkinsfile is a good reference for instructions on how to test and build this repository.
The service is deployed a debian package which is produced by this companion repository: https://github.com/exoscale/pkg-puppetdb . The tarball in that repository is produced by the build scripts and source code in this repository.

### Testing
Run java integration tests with an embedded database:

```bash
lein test
```

Run java integration tests with an external postgres database (assumes docker is installed):

**Dockerfile**

```
FROM registry.internal.exoscale.ch/exoscale/clojure:bionic

WORKDIR /app
CMD "lein run"
COPY . .
RUN lein deps
```

**docker-compose.yml**

```yaml
version: "3.7"

services:
  puppetdb:
    build: .
    command: "lein test"
    environment:
      T_LANG: java
      PUPPETDB_DBTYPE: postgres
      PUPPETDB_DBUSER: postgres
      PUPPETDB_DBSUBNAME: //postgres:5432/puppetdbtest
      PUPPETDB_DBPASSWORD: postgres
  postgres:
    image: postgres:9.5
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: puppetdbtest
```

### Build tarball
The tarball used to build the debian package in https://github.com/exoscale/pkg-puppetdb is produced as follows (this assumes clojure, lein and ruby are installed, see the Jenkinsfile for how to construct a reproducable environment):

```bash
# Install a vendored version of the packaging gem without relying on the host distribution
rake package:bootstrap
# Ensure an explicit user is set (useful inside a docker container which typically don't set these environment variables)
export USER=builder
# Produce the tarball
rake package:tar
# Move the tarball to the root and rename it to the structure the deb toolchain expects
mv pkg/*.tar.gz ./puppetdb_$(rake version | tr -d 'v').orig.tar.gz
```

Once the tarball is produced, it should be manually copied to the pkg-puppetdb repo and checked in there. See the instructions in `debian/README.md` of that repository for how to produce a deb package with a new version number from this tarball.


General Information
-----

* [FAQ and troubleshooting](./documentation/puppetdb-faq.markdown)
* [Overview & Requirements](./documentation/index.markdown)
* [Release Notes](./documentation/release_notes.markdown)
* [Known Issues](./documentation/known_issues.markdown)
* [Community Add-ons](./documentation/community_add_ons.markdown)

Installation
-----

* [Installing PuppetDB via the Puppet Module](./documentation/install_via_module.markdown)
* [Installing PuppetDB from Packages](./documentation/install_from_packages.markdown)
* [Connecting Puppet Masters](./documentation/connect_puppet_master.markdown)
* [Connecting Standalone Puppet](./documentation/connect_puppet_apply.markdown)
* [Upgrading PuppetDB](./documentation/upgrade.markdown)
* [Installing from Source](./documentation/install_from_source.markdown)

Administration
-----

* [Using PuppetDB](./documentation/using.markdown)
* [Maintaining and Tuning](./documentation/maintain_and_tune.markdown)
* [Scaling Recommendations](./documentation/scaling_recommendations.markdown)
* [Configuring](./documentation/configure.markdown)
* [Debugging with Remote REPL](./documentation/repl.markdown)

Troubleshooting
-----

* [KahaDB Corruption](./documentation/trouble_kahadb_corruption.markdown)

The PuppetDB API
-----

* [Overview](./documentation/api/query/index.markdown)
* [Curl Tips](./documentation/api/query/curl.markdown)
* [Commands](./documentation/api/commands.markdown)
* Querying
  * [Introduction](./documentation/api/query/v3/query.markdown)
  * [Tutorial](./documentation/api/query/tutorial.markdown)
  * [Operators](./documentation/api/query/v3/operators.markdown)
  * [Querying Nodes](./documentation/api/query/v3/nodes.markdown)
  * [Querying Facts](./documentation/api/query/v3/facts.markdown)
  * [Querying Fact Names](./documentation/api/query/v3/fact-names.markdown)
  * [Querying Resources](./documentation/api/query/v3/resources.markdown)
  * [Querying Metrics](./documentation/api/query/v3/metrics.markdown)
  * [Querying Reports](./documentation/api/query/v3/reports.markdown)
  * [Querying Events](./documentation/api/query/v3/events.markdown)
* Wire Formats
  * [Catalog Format](./documentation/api/wire_format/catalog_format.markdown)
  * [Facts Format](./documentation/api/wire_format/facts_format.markdown)
  * [Report Format](./documentation/api/wire_format/report_format.markdown)


# Special thanks to

## YourKit

YourKit has given us an open source license for their profiler, greatly
simplifying the profiling of PuppetDB's performance.

YourKit is kindly supporting open source projects with its full-featured Java
Profiler. YourKit, LLC is the creator of innovative and intelligent tools for
profiling Java and .NET applications. Take a look at YourKit's leading software
products:

* [YourKit Java Profiler](http://www.yourkit.com/java/profiler/index.jsp)
* [YourKit .NET Profiler](http://www.yourkit.com/.net/profiler/index.jsp)

[leiningen]: https://github.com/technomancy/leiningen
